<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Reservas Médicas</title>

<style>
body{
  font-family: "Segoe UI", sans-serif;
  background:#eef2f7;
  padding:20px;
}
.card{
  max-width:900px;
  margin:auto;
  background:#fff;
  padding:25px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
h2,h3{margin-top:0}
input,button{
  padding:10px;
  width:100%;
  margin:6px 0;
  font-size:14px;
}
button{
  background:#1976d2;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:hover{opacity:.9}
button.danger{background:#d32f2f}
table{
  width:100%;
  margin-top:20px;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
  text-align:left;
}
th{background:#f5f7fa}
.msg{
  margin:10px 0;
  font-weight:bold;
}
</style>
</head>

<body>
<div class="card">

<h2>Reservar / Editar Cita</h2>

<input id="paciente" placeholder="Paciente">
<input id="medico" placeholder="Médico">
<input type="date" id="fecha">
<input type="time" id="hora" step="60">
<input id="telefono" placeholder="Teléfono">

<button onclick="guardar()">Guardar / Actualizar</button>
<button onclick="limpiar()">Limpiar</button>

<div id="msg" class="msg"></div>

<hr>

<h3>Buscar Citas</h3>
<input type="date" id="fFecha">
<input id="fTexto" placeholder="Médico o Paciente">
<button onclick="listar()">Buscar</button>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>Hora</th>
  <th>Médico</th>
  <th>Paciente</th>
  <th>Acción</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>

</div>

<script>
let indiceEdicion = null;
let cache = [];

/* ================= GUARDAR / ACTUALIZAR ================= */
function guardar(){
  msg.innerText = "";

  const datos = {
    paciente: paciente.value.trim(),
    medico: medico.value.trim(),
    fecha: fecha.value,
    hora: hora.value,
    telefono: telefono.value.trim(),
    indice: indiceEdicion
  };

  google.script.run
    .withSuccessHandler(r=>{
      msg.innerText = r;
      msg.style.color = "green";
      listar();
      limpiar(false);
    })
    .withFailureHandler(e=>{
      msg.innerText = e.message;
      msg.style.color = "red";
    })
    .guardarOActualizarCita(datos);
}

/* ================= LISTAR ================= */
function listar(){
  tb.innerHTML = "<tr><td colspan='5'>Cargando...</td></tr>";

  google.script.run
    .withSuccessHandler(d=>{
      cache = d;
      tb.innerHTML = "";

      if(!d.length){
        tb.innerHTML = "<tr><td colspan='5'>No hay resultados</td></tr>";
        return;
      }

      d.forEach((c,i)=>{
        tb.innerHTML += `
        <tr>
          <td>${c.fecha}</td>
          <td>${c.hora}</td>
          <td>${c.medico}</td>
          <td>${c.paciente}</td>
          <td>
            <button onclick="editar(${i})">Editar</button>
            <button class="danger" onclick="cancelar(${c.indiceOriginal})">X</button>
          </td>
        </tr>`;
      });
    })
    .withFailureHandler(()=>{
      tb.innerHTML = "<tr><td colspan='5'>Error al cargar</td></tr>";
    })
    .obtenerCitasFiltradas({
      fecha: fFecha.value,
      texto: fTexto.value
    });
}

/* ================= EDITAR ================= */
function editar(i){
  const c = cache[i];

  paciente.value = c.paciente;
  medico.value = c.medico;
  fecha.value = c.fechaRaw;
  hora.value = c.hora;
  telefono.value = c.telefono || "";

  indiceEdicion = c.indiceOriginal;

  msg.innerText = "✏️ Modo edición activado";
  msg.style.color = "orange";
  window.scrollTo(0,0);
}

/* ================= CANCELAR ================= */
function cancelar(i){
  if(confirm("¿Cancelar esta cita?")){
    google.script.run
      .withSuccessHandler(r=>{
        alert(r);
        listar();
      })
      .withFailureHandler(e=>{
        alert(e.message);
      })
      .cancelarCitaServidor(i);
  }
}

/* ================= LIMPIAR ================= */
function limpiar(borrarMsg=true){
  paciente.value = "";
  medico.value = "";
  fecha.value = "";
  hora.value = "";
  telefono.value = "";
  indiceEdicion = null;
  if(borrarMsg) msg.innerText = "";
}
</script>

</body>
</html>
